<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Automate UFW with Nginx and TCP wrapper" /><meta property="og:locale" content="en" /><meta name="description" content="The why?" /><meta property="og:description" content="The why?" /><link rel="canonical" href="https://github.com/jonnypeace/jonnypeace.github.io.git/posts/ufw-nginx/" /><meta property="og:url" content="https://github.com/jonnypeace/jonnypeace.github.io.git/posts/ufw-nginx/" /><meta property="og:site_name" content="HomeLab Hub" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-04-02T12:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Automate UFW with Nginx and TCP wrapper" /><meta name="twitter:site" content="@JonnyLinuxPeace" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-04-06T23:07:57+01:00","datePublished":"2023-04-02T12:00:00+01:00","description":"The why?","headline":"Automate UFW with Nginx and TCP wrapper","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/jonnypeace/jonnypeace.github.io.git/posts/ufw-nginx/"},"url":"https://github.com/jonnypeace/jonnypeace.github.io.git/posts/ufw-nginx/"}</script><title>Automate UFW with Nginx and TCP wrapper | HomeLab Hub</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="HomeLab Hub"><meta name="application-name" content="HomeLab Hub"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/motherboard.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">HomeLab Hub</a></div><div class="site-subtitle font-italic">Your one-stop for bash, python & Linux magic</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/jonnypeace" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/JonnyLinuxPeace" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['jonnypeace','outlook.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Automate UFW with Nginx and TCP wrapper</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Automate UFW with Nginx and TCP wrapper</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1680433200" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 2, 2023 </em> </span> <span> Updated <em class="" data-ts="1680818877" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 6, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/JonnyLinuxPeace">jonny peace</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1183 words"> <em>6 min</em> read</span></div></div></div><div class="post-content"><h1 id="the-why">The why?</h1><p>This is a shell script that I do use quite frequently, since itâ€™s been run in a cron job to check for host lookup ip changes (utilizing dynamic DNS). This saves users from being locked out if their home ip address changes, also helps keep a stronger firewall.</p><p>This basic example will allow two people to access SSH and HTTPS ports.. This works so long as those two people are allowed access on those ports, so this script would probably need modified to accomodate, or just use seperate scripts for groups of individuals.</p><p>The only section of this script to adjust are the two arrays, one for ports and the other is clients, at the top of the script. If you want to add more, just follow the same format with ports and clients. Comment out or delete sections with nginx or hosts.allow if not required.</p><p>If using hosts.deny, this script will accomdate a hosts.allow, but obviously this could be modified also. If you want to use this TCP wrapper, put a â€˜sshd: ALLâ€™ or something along those lines which suits your needs in your hosts.deny.</p><p>If using the nginx side, place this key in the server block of your nginx config. #SED-MATCH-LEAVE I could have used a substitute option for sed up to a point, but at least with this method, it will help with the set up of a newly created config or new user. Also if using the nginx config like me, and you donâ€™t need the world wide web on your server, place a <em>deny all;</em> in the server block underneath the allowed ipâ€™s.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
</pre><td class="rouge-code"><pre><span class="c">#!/bin/bash</span>
<span class="c">#allow a dyndns name through your firewall. The idea is to set up a crontab</span>
<span class="c">#to look up the dns hostname so you always have access to the server, via</span>
<span class="c">#your port and protocol of choice. I use something like this to keep a VPN</span>
<span class="c">#tunnel open to a server.</span>

<span class="c">#for manual entry, syntax in terminal for UFW....</span>
<span class="c">#./script.sh ip port proto, i.e.</span>
<span class="c">#./script.sh 123.12.123.12 22 tcp</span>

<span class="nb">declare</span> <span class="nt">-A</span> ports
<span class="c"># Update ports to cycle through your firewall</span>
ports[ssh]<span class="o">=</span>12345
ports[https]<span class="o">=</span>443
<span class="c">#ports[]=</span>

<span class="nb">declare</span> <span class="nt">-A</span> clients
<span class="c"># Check hosts associated with client</span>
clients[jamie]<span class="o">=</span><span class="si">$(</span>host homeIPaddress1.ddns.net | <span class="nb">cut</span> <span class="nt">-f4</span> <span class="nt">-d</span><span class="s1">' '</span><span class="si">)</span>
clients[holly]<span class="o">=</span><span class="si">$(</span>host homeIPaddress2.ddns.net | <span class="nb">cut</span> <span class="nt">-f4</span> <span class="nt">-d</span><span class="s1">' '</span><span class="si">)</span>
<span class="c">#clients[]=</span>

<span class="c"># nginx config file</span>
<span class="nv">nginx_conf</span><span class="o">=</span><span class="s1">'/etc/nginx/conf.d/web.conf'</span>

<span class="c"># Check if any ufw rules</span>
<span class="k">if</span> <span class="o">[[</span> <span class="si">$(</span><span class="nb">sudo </span>ufw status | <span class="nb">wc</span> <span class="nt">-l</span><span class="si">)</span> <span class="o">==</span> 1 <span class="o">]]</span>
<span class="k">then
  </span><span class="nv">append</span><span class="o">=</span>True
<span class="k">fi

</span><span class="nb">mkdir</span> <span class="nt">-p</span> <span class="s2">"</span><span class="nv">$HOME</span><span class="s2">"</span>/logs

<span class="nv">timelog</span><span class="o">=</span><span class="s2">"</span><span class="nv">$HOME</span><span class="s2">"</span>/logs/dyndnstime.log
<span class="nv">now</span><span class="o">=</span><span class="si">$(</span><span class="nb">printf</span> <span class="s1">'%(%d-%m-%Y %H:%M:%S)T\n'</span><span class="si">)</span>

<span class="k">function </span>sed-nginx <span class="o">{</span>
  <span class="c"># Update an nginx config if you have one? Test on a dummy nginx config beforehand.</span>
  <span class="c"># You might also want to change a subnet instead, replace or leave out entirely</span>
  <span class="c"># An example of append (Placing that comment '#SED-MATCH-LEAVE' somewhere in your nginx config file (server block))</span>
  <span class="c"># I'm using \\\t to get a tab space in the conf, might need adjusted</span>
  <span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s2">"/#SED-MATCH-LEAVE/a </span><span class="se">\\\t</span><span class="s2">allow </span><span class="k">${</span><span class="nv">clients</span><span class="p">[</span><span class="nv">$client</span><span class="p">]</span><span class="k">}</span><span class="s2">;"</span> <span class="s2">"</span><span class="nv">$nginx_conf</span><span class="s2">"</span>
<span class="o">}</span>

<span class="c"># adds new UFW firewall rules</span>
<span class="k">function </span>add-new-rules <span class="o">{</span>
  <span class="k">for </span>port <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="nv">ports</span><span class="p">[@]</span><span class="k">}</span><span class="s2">"</span><span class="p">;</span> <span class="k">do
    if</span> <span class="o">[[</span> <span class="nv">$append</span> <span class="o">==</span> True <span class="o">]]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">sudo </span>ufw allow from <span class="s2">"</span><span class="k">${</span><span class="nv">clients</span><span class="p">[</span><span class="nv">$client</span><span class="p">]</span><span class="k">}</span><span class="s2">"</span> to any port <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> proto tcp
    <span class="k">else</span>
      <span class="c"># The reason for inserting new rules, is to keep them above any rate limiting rules which might interfere with the users. I've chosen 1 to keep above all rules.</span>
      <span class="nb">sudo </span>ufw insert 1 allow from <span class="s2">"</span><span class="k">${</span><span class="nv">clients</span><span class="p">[</span><span class="nv">$client</span><span class="p">]</span><span class="k">}</span><span class="s2">"</span> to any port <span class="s2">"</span><span class="nv">$port</span><span class="s2">"</span> proto tcp
    <span class="k">fi
  done</span>
<span class="o">}</span>

<span class="c"># If no commandline options...</span>
<span class="k">if</span> <span class="o">[[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]]</span>
<span class="k">then
  for </span>client <span class="k">in</span> <span class="s2">"</span><span class="k">${</span><span class="p">!clients[@]</span><span class="k">}</span><span class="s2">"</span>
  <span class="k">do</span>
    <span class="c"># If no ip found from host, continue to next host, otherwise hosts.allow may fill with junk</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="k">${</span><span class="nv">clients</span><span class="p">[</span><span class="nv">$client</span><span class="p">]</span><span class="k">}</span> <span class="o">=</span>~ <span class="o">[</span>0-9]<span class="o">{</span>1,3<span class="o">}</span><span class="se">\.</span><span class="o">[</span>0-9]<span class="o">{</span>1,3<span class="o">}</span><span class="se">\.</span><span class="o">[</span>0-9]<span class="o">{</span>1,3<span class="o">}</span><span class="se">\.</span><span class="o">[</span>0-9]<span class="o">{</span>1,3<span class="o">}</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">echo</span> <span class="s2">"No ip found from </span><span class="k">${</span><span class="nv">client</span><span class="k">}</span><span class="s2">, moving to next client"</span>
      <span class="k">continue
    fi
    </span><span class="nv">logfile</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">HOME</span><span class="k">}</span><span class="s2">/logs/</span><span class="k">${</span><span class="nv">client</span><span class="k">}</span><span class="s2">.ip.log"</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nt">-f</span> <span class="s2">"</span><span class="nv">$logfile</span><span class="s2">"</span> <span class="o">]]</span>
    <span class="k">then</span>
      <span class="c"># data will be stored in the users $HOME directory and not the root directory.</span>
      <span class="c"># add new UFW rules</span>
      add-new-rules

      <span class="c"># Update an nginx config if you have one? Test on a dummy nginx config beforehand.</span>
      <span class="c"># Remove or comment out line below if you don't need this</span>
      sed-nginx

      <span class="c"># hosts allow file update</span>
      <span class="nb">echo</span> <span class="s2">"ALL: </span><span class="k">${</span><span class="nv">clients</span><span class="p">[</span><span class="nv">$client</span><span class="p">]</span><span class="k">}</span><span class="s2"> # Home"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts.allow
      <span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">clients</span><span class="p">[</span><span class="nv">$client</span><span class="p">]</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$logfile</span><span class="s2">"</span>
      <span class="nb">echo</span> <span class="s2">"New host time log created"</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$timelog</span><span class="s2">"</span>
    <span class="k">else
      </span><span class="nv">old_ip</span><span class="o">=</span><span class="si">$(</span>&lt; <span class="s2">"</span><span class="nv">$logfile</span><span class="s2">"</span><span class="si">)</span>
      <span class="k">if</span> <span class="o">[[</span> <span class="k">${</span><span class="nv">clients</span><span class="p">[</span><span class="nv">$client</span><span class="p">]</span><span class="k">}</span> <span class="o">==</span> <span class="s2">"</span><span class="nv">$old_ip</span><span class="s2">"</span> <span class="o">]]</span>
      <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$client</span><span class="s2"> IP address has not changed"</span>
        <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$now</span><span class="s2"> : </span><span class="nv">$client</span><span class="s2"> : log running every hour, no changes"</span> <span class="o">&gt;&gt;</span> <span class="s2">"</span><span class="nv">$timelog</span><span class="s2">"</span>
      <span class="k">else</span>
        <span class="c"># Remove old IPs from client</span>
        <span class="nv">num_rules</span><span class="o">=</span><span class="si">$(</span><span class="nb">sudo </span>ufw status numbered | <span class="nb">grep</span> <span class="nt">-c</span> <span class="s2">"</span><span class="nv">$old_ip</span><span class="s2">"</span><span class="si">)</span>
        <span class="k">for</span> <span class="o">((</span> <span class="nv">a</span><span class="o">=</span>1<span class="p">;</span> a&lt;<span class="o">=</span>num_rules<span class="p">;</span> a++  <span class="o">))</span><span class="p">;</span> <span class="k">do
          </span><span class="nv">first_rule</span><span class="o">=</span><span class="si">$(</span><span class="nb">sudo </span>ufw status numbered | <span class="nb">grep</span> <span class="s2">"</span><span class="nv">$old_ip</span><span class="s2">"</span> | <span class="nb">sed</span> <span class="nt">-En</span> <span class="s2">"1s/.*([0-9]+)</span><span class="se">\]</span><span class="s2">.*/</span><span class="se">\1</span><span class="s2">/p"</span><span class="si">)</span>
          <span class="nb">echo</span> <span class="s2">"y"</span> | <span class="nb">sudo </span>ufw delete <span class="s2">"</span><span class="nv">$first_rule</span><span class="s2">"</span>
        <span class="k">done</span>
        <span class="c"># Clean up hosts.allow file</span>
        <span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s2">"/</span><span class="nv">$old_ip</span><span class="s2">/d"</span> /etc/hosts.allow
        <span class="c"># Clean up nginx conf</span>
        <span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s2">"/</span><span class="nv">$old_ip</span><span class="s2">/d"</span> <span class="s2">"</span><span class="nv">$nginx_conf</span><span class="s2">"</span>
        
        <span class="c"># Add new rules</span>
        add-new-rules

        <span class="c"># Update an nginx config if you have one? Test on a dummy nginx config beforehand. You might change to many ip addresses with this command.</span>
        <span class="c"># Remove line below if you don't need this</span>
        sed-nginx

        <span class="c"># update hosts allow file</span>
        <span class="nb">echo</span> <span class="s2">"ALL: </span><span class="k">${</span><span class="nv">clients</span><span class="p">[</span><span class="nv">$client</span><span class="p">]</span><span class="k">}</span><span class="s2"> # Home"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts.allow
        <span class="nb">echo</span> <span class="s2">"</span><span class="k">${</span><span class="nv">clients</span><span class="p">[</span><span class="nv">$client</span><span class="p">]</span><span class="k">}</span><span class="s2">"</span> <span class="o">&gt;</span> <span class="s2">"</span><span class="nv">$logfile</span><span class="s2">"</span>
        <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$client</span><span class="s2"> IP has been updated"</span>
        <span class="nb">echo</span> <span class="s2">"</span><span class="nv">$now</span><span class="s2"> : </span><span class="nv">$client</span><span class="s2"> New IP updated"</span> <span class="o">&gt;&gt;</span> <span class="s2">"</span><span class="nv">$timelog</span><span class="s2">"</span>
      <span class="k">fi
    fi
  done
else</span>
    <span class="c"># Sense checking the commandline entries</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nv">$1</span> <span class="o">=</span>~ <span class="o">[</span>0-9]<span class="o">{</span>1,3<span class="o">}</span><span class="se">\.</span><span class="o">[</span>0-9]<span class="o">{</span>1,3<span class="o">}</span><span class="se">\.</span><span class="o">[</span>0-9]<span class="o">{</span>1,3<span class="o">}</span><span class="se">\.</span><span class="o">[</span>0-9]<span class="o">{</span>1,3<span class="o">}</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2"> is not a valid ip address"</span>
      <span class="nb">exit </span>1
    <span class="k">fi
    if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nv">$2</span> <span class="o">=</span>~ <span class="o">[</span>0-9]<span class="o">{</span>1,5<span class="o">}</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2"> is not a valid port number"</span>
      <span class="nb">exit </span>1
    <span class="k">fi
    if</span> <span class="o">[[</span> <span class="o">!</span> <span class="nv">$3</span> <span class="o">=</span>~ ^tcp<span class="nv">$|</span>^udp<span class="nv">$ </span><span class="o">]]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">echo</span> <span class="s2">"</span><span class="nv">$3</span><span class="s2"> is not a valid protocol, use tcp or udp"</span>
      <span class="nb">exit </span>1
    <span class="k">fi 
    if</span> <span class="o">[[</span> <span class="nv">$append</span> <span class="o">==</span> True <span class="o">]]</span><span class="p">;</span> <span class="k">then
      </span><span class="nb">sudo </span>ufw allow from <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> to any port <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> proto <span class="s2">"</span><span class="nv">$3</span><span class="s2">"</span>
    <span class="k">else
      </span><span class="nb">sudo </span>ufw insert 1 allow from <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> to any port <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> proto <span class="s2">"</span><span class="nv">$3</span><span class="s2">"</span>
    <span class="k">fi
    </span><span class="nb">echo</span> <span class="s2">"ALL: </span><span class="nv">$1</span><span class="s2"> # Home"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/hosts.allow
    <span class="c"># Update an nginx config if you have one? Test on a dummy nginx config beforehand.</span>
    <span class="c"># Remove line below if you don't need this</span>
    <span class="c"># An example of append (Placing that comment '#SED-MATCH-LEAVE' somewhere in your nginx config file (server block))</span>
    <span class="c"># I'm using \\\t to get a tab space in the conf, might need adjusted</span>
    <span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s2">"/#SED-MATCH-LEAVE/a </span><span class="se">\\\t</span><span class="s2">allow </span><span class="nv">$1</span><span class="s2">;"</span> <span class="s2">"</span><span class="nv">$nginx_conf</span><span class="s2">"</span>
  <span class="k">fi</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/homelab/'>homelab</a>, <a href='/categories/firewall/'>firewall</a>, <a href='/categories/ufw/'>UFW</a>, <a href='/categories/nginx/'>Nginx</a>, <a href='/categories/security/'>Security</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/firewall/" class="post-tag no-text-decoration" >Firewall</a> <a href="/tags/ufw/" class="post-tag no-text-decoration" >UFW</a> <a href="/tags/nginx/" class="post-tag no-text-decoration" >Nginx</a> <a href="/tags/security/" class="post-tag no-text-decoration" >Security</a> <a href="/tags/hosts-allow/" class="post-tag no-text-decoration" >hosts.allow</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Automate+UFW+with+Nginx+and+TCP+wrapper+-+HomeLab+Hub&url=https%3A%2F%2Fgithub.com%2Fjonnypeace%2Fjonnypeace.github.io.git%2Fposts%2Fufw-nginx%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Automate+UFW+with+Nginx+and+TCP+wrapper+-+HomeLab+Hub&u=https%3A%2F%2Fgithub.com%2Fjonnypeace%2Fjonnypeace.github.io.git%2Fposts%2Fufw-nginx%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fgithub.com%2Fjonnypeace%2Fjonnypeace.github.io.git%2Fposts%2Fufw-nginx%2F&text=Automate+UFW+with+Nginx+and+TCP+wrapper+-+HomeLab+Hub" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/docker-lxd-keepalive/">High Availability with KeepaliveD-Docker-LXD</a><li><a href="/posts/arch-printer/">Setting up an HP Printer on Arch Linux</a><li><a href="/posts/basic-zfs/">ZFS Mirror, Snapshots, Recovery</a><li><a href="/posts/neovim-customization/">Setting up a Custom Neovim config on Arch Linux</a><li><a href="/posts/inc-tar/">Simple Incremental Backup Script</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/lxd/">lxd</a> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/arch-linux/">Arch Linux</a> <a class="post-tag" href="/tags/backup/">backup</a> <a class="post-tag" href="/tags/firewall/">firewall</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/servers/">servers</a> <a class="post-tag" href="/tags/zfs/">zfs</a></div></div></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/abuse-ip/"><div class="card-body"> <em class="small" data-ts="1682683200" data-df="ll" > Apr 28, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Automate IP blaclists with IPtables and IPset</h3><div class="text-muted small"><p> The why.. Gather data from abuse IP database and update firewall rules using ipset This script is fairly recent, so might need some modifications. Dependenciesâ€¦. 1 apt install ipset-persistent ...</p></div></div></a></div><div class="card"> <a href="/posts/snap-makemkv/"><div class="card-body"> <em class="small" data-ts="1693051200" data-df="ll" > Aug 26, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MakeMKV install using snap</h3><div class="text-muted small"><p> The why? This is a useful programme for archiving collections of your blu-rays or DVDs, and for using with applications like jellyfin, plex etc. Very Easy Instructions using snaps The latest/sta...</p></div></div></a></div><div class="card"> <a href="/posts/backup-lxd/"><div class="card-body"> <em class="small" data-ts="1694966400" data-df="ll" > Sep 17, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Backup/Copy LXD container to another host</h3><div class="text-muted small"><p> The why? Although I run LXD in clusters, my clusters are generally low powered that donâ€™t need much compute. So i do run some services that require compute, on my laptop or desktop in LXD, and he...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/ans-nc-lxd/" class="btn btn-outline-primary" prompt="Older"><p>Ansible / Bash - Nextcloud Deployment - LXD</p></a> <a href="/posts/abuse-ip/" class="btn btn-outline-primary" prompt="Newer"><p>Automate IP blaclists with IPtables and IPset</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> Â© 2025 <a href="https://twitter.com/JonnyLinuxPeace">jonny peace</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/lxd/">lxd</a> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/arch-linux/">Arch Linux</a> <a class="post-tag" href="/tags/backup/">backup</a> <a class="post-tag" href="/tags/firewall/">firewall</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/servers/">servers</a> <a class="post-tag" href="/tags/zfs/">zfs</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3"></p><button type="button" class="btn btn-primary" aria-label="Update"> </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
