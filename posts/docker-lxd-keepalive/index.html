<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="High Availability with KeepaliveD-Docker-LXD" /><meta property="og:locale" content="en" /><meta name="description" content="Docker-LXD-KeepaliveD" /><meta property="og:description" content="Docker-LXD-KeepaliveD" /><link rel="canonical" href="https://github.com/jonnypeace/jonnypeace.github.io.git/posts/docker-lxd-keepalive/" /><meta property="og:url" content="https://github.com/jonnypeace/jonnypeace.github.io.git/posts/docker-lxd-keepalive/" /><meta property="og:site_name" content="HomeLab Hub" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-04-28T13:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="High Availability with KeepaliveD-Docker-LXD" /><meta name="twitter:site" content="@JonnyLinuxPeace" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2025-09-29T07:44:02+01:00","datePublished":"2023-04-28T13:00:00+01:00","description":"Docker-LXD-KeepaliveD","headline":"High Availability with KeepaliveD-Docker-LXD","mainEntityOfPage":{"@type":"WebPage","@id":"https://github.com/jonnypeace/jonnypeace.github.io.git/posts/docker-lxd-keepalive/"},"url":"https://github.com/jonnypeace/jonnypeace.github.io.git/posts/docker-lxd-keepalive/"}</script><title>High Availability with KeepaliveD-Docker-LXD | HomeLab Hub</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="HomeLab Hub"><meta name="application-name" content="HomeLab Hub"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/motherboard.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">HomeLab Hub</a></div><div class="site-subtitle font-italic">Your one-stop for bash, python & Linux magic</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/jonnypeace" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/JonnyLinuxPeace" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['jonnypeace','outlook.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>High Availability with KeepaliveD-Docker-LXD</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>High Availability with KeepaliveD-Docker-LXD</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1682683200" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Apr 28, 2023 </em> </span> <span> Updated <em class="" data-ts="1759128242" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Sep 29, 2025 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/JonnyLinuxPeace">jonny peace</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="921 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><h1 id="docker-lxd-keepalived">Docker-LXD-KeepaliveD</h1><p>This should be a <em>mostly straight forward</em> setup. There are plenty other ways to configure, this probably the easiest.</p><p>Also, this would work better if you are in an LXD cluster, which is out of scope for this, but will add a short section about it further down.</p><p>Also also, instead of a network share to synchronize the containers, you should probably use microceph with LXD (microcloud), which would also handle migration much better, but for now, i’ll go with network share, and will probably add a bit with microceph later - i’ve not tried it with docker, so we’ll see how that goes :) .</p><h2 id="git-repo"><span class="mr-2">Git Repo</span><a href="#git-repo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>First of all, clone the git repo…</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>git clone https://github.com/jonnypeace/docker-lxd-keepalived.git
</pre></table></code></div></div><h2 id="setting-up-an-lxd-container-to-use-with-docker"><span class="mr-2">Setting up an LXD container to use with docker</span><a href="#setting-up-an-lxd-container-to-use-with-docker" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Docker cant run on zfs</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lxc storage list <span class="c"># you'll see storage pools here.</span>
</pre></table></code></div></div><p>Create a pool called docker with btrfs</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lxc storage create docker btrfs
</pre></table></code></div></div><p>Launch an ubuntu container called fast-ubuntu</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lxc launch images:ubuntu/22.04 fast-ubuntu
</pre></table></code></div></div><p>Create storage volume for fast-ubuntu</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lxc storage volume create docker fast-ubuntu
</pre></table></code></div></div><p>Add storage from storage pool docker created earlier to fast-ubuntu, and use it for /var/lib/docker</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lxc config device add fast-ubuntu docker disk <span class="nv">pool</span><span class="o">=</span>docker <span class="nb">source</span><span class="o">=</span>fast-ubuntu <span class="nv">path</span><span class="o">=</span>/var/lib/docker
</pre></table></code></div></div><p>Poke some holes so docker can run inside the LXD containers</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lxc config <span class="nb">set </span>fast-ubuntu security.nesting<span class="o">=</span><span class="nb">true </span>security.syscalls.intercept.mknod<span class="o">=</span><span class="nb">true </span>security.syscalls.intercept.setxattr<span class="o">=</span><span class="nb">true</span>
</pre></table></code></div></div><p>Restart container</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lxc restart fast-ubuntu
</pre></table></code></div></div><p>Enter container and run bash</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lxc <span class="nb">exec </span>fast-ubuntu bash
</pre></table></code></div></div><p>Install docker (Worth checking dockers website in case this procedure changes) and install docker-compose &amp; keepalived</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre>apt update <span class="o">&amp;&amp;</span> apt upgrade <span class="nt">-y</span>

<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install</span> <span class="se">\</span>
   ca-certificates <span class="se">\</span>
   curl <span class="se">\</span>
   gnupg <span class="se">\</span>
   lsb-release

<span class="nb">mkdir</span> <span class="nt">-p</span> /etc/apt/keyrings
curl <span class="nt">-fsSL</span> https://download.docker.com/linux/ubuntu/gpg | <span class="nb">sudo </span>gpg <span class="nt">--dearmor</span> <span class="nt">-o</span> /etc/apt/keyrings/docker.gpg

<span class="nb">echo</span> <span class="se">\</span>
<span class="s2">"deb [arch=</span><span class="si">$(</span>dpkg <span class="nt">--print-architecture</span><span class="si">)</span><span class="s2"> signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu </span><span class="se">\</span><span class="s2">
</span><span class="si">$(</span>lsb_release <span class="nt">-cs</span><span class="si">)</span><span class="s2"> stable"</span> | <span class="nb">sudo tee</span> /etc/apt/sources.list.d/docker.list <span class="o">&gt;</span> /dev/null

<span class="nb">sudo </span>apt-get update
<span class="nb">sudo </span>apt-get <span class="nb">install </span>docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-compose keepalived
</pre></table></code></div></div><p>Test docker install</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>docker run <span class="nt">-it</span> ubuntu bash <span class="c"># run exit or ctrl+D to exit - you'll want to remove this ubuntu image/container probably.</span>
</pre></table></code></div></div><p>List containers and grab ip.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lxc list fast-ubuntu <span class="c"># for ip</span>
</pre></table></code></div></div><p>Add network share - if you use this feature as per cron job below, adjust as necessary for both</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="c"># add network shares mounted on host</span>
<span class="c"># Source is the host mount</span>
<span class="c"># path is the mount inside the lxd container</span>
<span class="c"># network-share is the name of the device</span>
lxc config device add fast-ubuntu network-share disk <span class="nb">source</span><span class="o">=</span>/mnt/shares/ <span class="nv">path</span><span class="o">=</span>/mnt/docker
</pre></table></code></div></div><p>You’ll need two of these containers to run keepalived and since its high availability and LXD clusters…</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>lxc copy fast-ubuntu fast-ubuntu-slave <span class="nt">--target</span> server-name
</pre></table></code></div></div><p>If you’re just testing on a local machine, remove the –target server-name part of the above command</p><h2 id="monitorsh"><span class="mr-2">monitor.sh</span><a href="#monitorsh" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>This is used by keepalived to keep track of a service on your network… in my example, i’ve used portainer as an example</p><p>You’ll want to modify this for your own subnet…</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nv">ka_host_ip</span><span class="o">=</span><span class="s1">'10.10.200.69 9443'</span> <span class="c"># EDIT to suit subnet</span>
</pre></table></code></div></div><p>This ip will be the same (virtual) IP that is set in your keepalived config files</p><p>You’ll also want to edit this array for container names - as per docker-compose files.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>cont_arr[1]<span class="o">=</span><span class="s1">'portainer'</span> <span class="c"># This will also be used as my keepalived monitor container</span>
cont_arr[2]<span class="o">=</span><span class="s1">'freshrss'</span>
cont_arr[3]<span class="o">=</span><span class="s1">'vaultwarden'</span>
cont_arr[4]<span class="o">=</span><span class="s1">'watchtower'</span>
<span class="c">#cont_arr[5]=''</span>
<span class="c">#cont_arr[6]=''</span>
<span class="c">#cont_arr[7]=''</span>
</pre></table></code></div></div><p>Lastly for this script, the directory of /docker(/container) is assumed for all your docker-compose files. So you’ll want to modify as necessary. If you have docker-compose files scattered everywhere, this script won’t work.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="c"># root docker directory where containers located, following a pattern like so...</span>
<span class="c"># /docker/portainer, /docker/freshrss etc adjust as necessary.</span>
<span class="nv">dock_dir</span><span class="o">=</span><span class="s1">'/docker'</span>
</pre></table></code></div></div><h2 id="master--slave-keepalived-config-obviously-this-is-for-a-pair-of-servers"><span class="mr-2">Master &amp; Slave keepalived config (obviously this is for a pair of servers).</span><a href="#master--slave-keepalived-config-obviously-this-is-for-a-pair-of-servers" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>In your master server, copy etc.keepalived.master.conf file into /etc/keepalived/keepalived.conf</p><p>For your slave server, copy etc.keepalived.slave.conf file into /etc/keepalived/keepalived.conf</p><p>All that really needs modified here is this line, and ensure same virtual ip as in your monitor script.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>  10.10.200.69 <span class="c"># EDIT to suit subnet</span>
</pre></table></code></div></div><p>Lastly, you’ll want to enable and start keepalived</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>systemctl <span class="nb">enable</span> <span class="nt">--now</span> keepalived
</pre></table></code></div></div><p>If you run</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>systemctl status keepalived
</pre></table></code></div></div><p>The master will show…</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>Entering MASTER STATE
</pre></table></code></div></div><p>The slave will show…</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Entering BACKUP STATE
(VI_2) Changing effective priority from 80 to 81
</pre></table></code></div></div><p>Or something along those lones, depending probably whether the slave was a master to begin with. The main takeaway is that one will be in master state, and the other in backup state.</p><h2 id="docker-updatesh"><span class="mr-2">docker-update.sh</span><a href="#docker-updatesh" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I will probably update this to make it more fancy, but for now, it’s a simple brace expansion, test directory, change to directory, and pull new image and start container.</p><p>Again, this is assuming a root directory of /docker/containers….</p><p>So modify as necessary.</p><h2 id="cron-jobs"><span class="mr-2">cron jobs</span><a href="#cron-jobs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Again, this should be mostly self explanatory. I’ve shown how often i would run the monitor script, this means there should only really be around 1minute of downtime, give or take, depending if theres a docker image update.</p><p>So edit this for the location of the keepalived monitor script.</p><div class="language-bash highlighter-rouge"><div class="code-header"> <span data-label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Monitors every minute <span class="k">for </span>keepalived
<span class="k">*</span>/1 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> /home/user/monitor.sh
</pre></table></code></div></div><p>I’ve also shown a short rsync command to keep containers in sync over a mounted share, so you’ll want both servers to have the same mount if you use the same command as I.</p><p>Hope this helps, feel free to let me know if there are any issues.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/homelab/'>homelab</a>, <a href='/categories/docker/'>Docker</a>, <a href='/categories/keepalived/'>keepalived</a>, <a href='/categories/lxd/'>lxd</a>, <a href='/categories/bash/'>bash</a>, <a href='/categories/high-availability/'>high availability</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/homelab/" class="post-tag no-text-decoration" >homelab</a> <a href="/tags/docker/" class="post-tag no-text-decoration" >Docker</a> <a href="/tags/keepalived/" class="post-tag no-text-decoration" >keepalived</a> <a href="/tags/lxd/" class="post-tag no-text-decoration" >lxd</a> <a href="/tags/bash/" class="post-tag no-text-decoration" >bash</a> <a href="/tags/high-availability/" class="post-tag no-text-decoration" >high availability</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=High+Availability+with+KeepaliveD-Docker-LXD+-+HomeLab+Hub&url=https%3A%2F%2Fgithub.com%2Fjonnypeace%2Fjonnypeace.github.io.git%2Fposts%2Fdocker-lxd-keepalive%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=High+Availability+with+KeepaliveD-Docker-LXD+-+HomeLab+Hub&u=https%3A%2F%2Fgithub.com%2Fjonnypeace%2Fjonnypeace.github.io.git%2Fposts%2Fdocker-lxd-keepalive%2F" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fgithub.com%2Fjonnypeace%2Fjonnypeace.github.io.git%2Fposts%2Fdocker-lxd-keepalive%2F&text=High+Availability+with+KeepaliveD-Docker-LXD+-+HomeLab+Hub" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/docker-lxd-keepalive/">High Availability with KeepaliveD-Docker-LXD</a><li><a href="/posts/arch-printer/">Setting up an HP Printer on Arch Linux</a><li><a href="/posts/basic-zfs/">ZFS Mirror, Snapshots, Recovery</a><li><a href="/posts/neovim-customization/">Setting up a Custom Neovim config on Arch Linux</a><li><a href="/posts/inc-tar/">Simple Incremental Backup Script</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/lxd/">lxd</a> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/arch-linux/">Arch Linux</a> <a class="post-tag" href="/tags/backup/">backup</a> <a class="post-tag" href="/tags/firewall/">firewall</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/servers/">servers</a> <a class="post-tag" href="/tags/zfs/">zfs</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/backup-lxd/"><div class="card-body"> <em class="small" data-ts="1694966400" data-df="ll" > Sep 17, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Backup/Copy LXD container to another host</h3><div class="text-muted small"><p> The why? Although I run LXD in clusters, my clusters are generally low powered that don’t need much compute. So i do run some services that require compute, on my laptop or desktop in LXD, and he...</p></div></div></a></div><div class="card"> <a href="/posts/lxd-proxy-device/"><div class="card-body"> <em class="small" data-ts="1694966400" data-df="ll" > Sep 17, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Quick Proxy Setup for LXD</h3><div class="text-muted small"><p> The why? So I don’t forget is the main reason on this occasion. I have been playing with the idea of setting up an LXD container for code-server, but with a machine with enough grunt and doesn’t z...</p></div></div></a></div><div class="card"> <a href="/posts/jellyfin-nvidia-lxd/"><div class="card-body"> <em class="small" data-ts="1697378400" data-df="ll" > Oct 15, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Nvidia GPU LXD Passthrough</h3><div class="text-muted small"><p> On the host… Install Nvidia drivers 1 2 sudo apt install nvidia-driver-535 sudo reboot Check this website, but the deb network install seemed to work best. Nvidia Cuda Install Instructions As...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/abuse-ip/" class="btn btn-outline-primary" prompt="Older"><p>Automate IP blaclists with IPtables and IPset</p></a> <a href="/posts/snap-makemkv/" class="btn btn-outline-primary" prompt="Newer"><p>MakeMKV install using snap</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/JonnyLinuxPeace">jonny peace</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/homelab/">homelab</a> <a class="post-tag" href="/tags/lxd/">lxd</a> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/bash/">bash</a> <a class="post-tag" href="/tags/arch-linux/">Arch Linux</a> <a class="post-tag" href="/tags/backup/">backup</a> <a class="post-tag" href="/tags/firewall/">firewall</a> <a class="post-tag" href="/tags/python/">python</a> <a class="post-tag" href="/tags/servers/">servers</a> <a class="post-tag" href="/tags/zfs/">zfs</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3"></p><button type="button" class="btn btn-primary" aria-label="Update"> </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
